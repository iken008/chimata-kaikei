# データ保持ポリシー

このアプリケーションのデータ保持ポリシーと削除ルールをまとめています。

## 📊 データ種別と保持期間

### 1. 取引データ（transactions）
- **保持期間**: 年度に紐づく（無期限）
- **削除条件**: 年度の完全削除時に削除
- **場所**: `transactions` テーブル

### 2. 取引履歴（transaction_history）
- **保持期間**: 取引データと同じ
- **削除条件**: 年度の完全削除時に自動削除
- **場所**: `transaction_history` テーブル
- **実装**: `app/settings/page.tsx:1202-1207`

### 3. システム履歴（system_history）
- **保持期間**: 2年間
- **削除条件**: 2年以上前のレコードを定期的にクリーンアップ
- **場所**: `system_history` テーブル
- **クリーンアップ**: `cleanup_old_system_history.sql` を実行

### 4. 領収書画像（receipts）
- **保持期間**: 年度に紐づく（無期限）
- **削除条件**: 年度の完全削除時に削除
- **場所**: Supabase Storage `receipts` バケット

### 5. カテゴリー（categories）
- **保持期間**: 年度に紐づく（無期限）
- **削除条件**: 年度削除時にCASCADE削除
- **場所**: `categories` テーブル

## 🔄 年度削除時の削除対象

年度を完全削除すると、以下のデータが削除されます：

1. ✅ その年度の全取引データ
2. ✅ その年度の全取引履歴
3. ✅ その年度の全領収書画像
4. ✅ その年度の全カテゴリー（CASCADE）
5. ❌ システム履歴は削除されない（2年保持ポリシーに従う）

## 🗑️ クリーンアップ手順

### システム履歴のクリーンアップ（年1回推奨）

#### 方法1: 手動実行
1. Supabase Dashboard > SQL Editor を開く
2. `cleanup_old_system_history.sql` の内容をコピー
3. 「オプション2」で削除対象を確認
4. 「オプション1」で削除実行

#### 方法2: 関数を使った実行（推奨）
1. `cleanup_old_system_history.sql` のオプション3を実行して関数を作成
2. 以下のSQLを実行:
   ```sql
   SELECT * FROM cleanup_old_system_history();
   ```

#### 方法3: 自動実行（最も推奨）
1. Supabase Dashboard > Database > Cron Jobs
2. 新規ジョブを作成:
   - **ジョブ名**: cleanup_old_system_history
   - **スケジュール**: `0 0 1 1 *` (毎年1月1日午前0時)
   - **SQL**: `SELECT cleanup_old_system_history();`

## 📋 推奨運用フロー

### 古い年度の処理（例: 3年以上前の年度）

1. **アーカイブを作成** 📦
   - 設定 > データ管理 > 「アーカイブ作成」
   - ZIPファイルをダウンロード（CSV + 領収書画像）
   - 安全な場所に保管

2. **完全削除を実行** 🗑️
   - 設定 > データ管理 > 「完全削除」
   - 取引データ、履歴、画像がすべて削除される
   - データベース容量が解放される

3. **システム履歴のクリーンアップ** 🧹
   - 年1回、1月1日に自動実行（推奨）
   - または手動で `cleanup_old_system_history.sql` を実行

## 💾 ストレージ削減効果

| データ種別 | 削減効果 | 削除方法 |
|-----------|---------|---------|
| 取引データ | 中 | 年度削除 |
| 取引履歴 | 中 | 年度削除時に自動 |
| システム履歴 | 小 | クリーンアップSQL |
| 領収書画像 | **大** | 年度削除 |

⚠️ **重要**: 領収書画像が最も容量を消費します。古い年度はアーカイブ後に削除することを強く推奨します。

## 🔒 監査証跡の保持

システム履歴には以下の重要な操作が記録されます：

- 年度の作成・編集・削除
- カテゴリーの追加・編集・削除
- メンバーの追加・削除
- アーカイブの作成

これらは監査証跡として2年間保持されます。

## 📝 法的要件との整合性

日本の会計基準では、会計帳簿は原則として**7年間の保存**が義務付けられています。

このアプリケーションでは：
- **実データ（取引・領収書）**: アーカイブで7年保存可能
- **操作履歴（システム履歴）**: 2年間自動保持
- **推奨**: 古い年度はアーカイブ作成後、データベースから削除

アーカイブしたZIPファイルを7年間保管することで、法的要件を満たすことができます。
