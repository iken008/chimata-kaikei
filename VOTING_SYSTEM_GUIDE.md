# 年度削除の多数決システム 使い方ガイド

「みんなで見張る」設計思想に基づいた、年度削除の民主的な承認システムです。

## 🎯 コンセプト

年度の削除は重要な操作のため、**メンバー全員の過半数の承認**が必要になります。

## 📋 セットアップ手順

### ステップ1: データベース設定

1. Supabase Dashboard > SQL Editor を開く
2. `create_deletion_voting_system.sql` の内容をコピー＆ペースト
3. Run をクリック

これで以下のテーブルが作成されます：
- `deletion_proposals` - 削除提案を管理
- `deletion_votes` - メンバーの投票を記録

## 🔄 使い方

### 年度削除の提案（誰でも可能）

1. **設定** > **💾 データ** タブを開く
2. 削除したい年度の **📋 削除を提案** ボタンをクリック
3. 提案が作成され、全メンバーに表示されます

**提案内容:**
- 年度名
- 必要な承認数（メンバー数の過半数）
- 有効期限: 48時間

### 投票する

提案が作成されると、「🗳️ 削除提案（投票）」セクションに表示されます。

各メンバーは以下のいずれかを選択：
- **✅ 賛成** - 削除に賛成
- **❌ 反対** - 削除に反対

**注意点:**
- 1人1票のみ
- 一度投票すると変更不可
- 48時間以内に投票

### 承認・否決・期限切れ

#### ✅ 承認（過半数が賛成）
- ステータスが「✅ 承認済み」に変更
- **🗑️ 削除を実行する** ボタンが表示される
- 誰でも削除を実行可能（最終確認あり）

#### ❌ 否決（過半数が反対）
- ステータスが「❌ 却下」に変更
- 削除は実行されない

#### ⏰ 期限切れ（48時間以内に過半数なし）
- ステータスが「⏰ 期限切れ」に変更
- 削除は実行されない
- 再度提案する必要がある

### 削除の実行

承認された提案のみ、削除を実行できます：

1. **🗑️ 削除を実行する** ボタンをクリック
2. 最終確認ダイアログで「OK」
3. 年度データが完全に削除される

**削除されるデータ:**
- 全ての取引データ
- 全ての履歴データ
- 全ての領収書画像
- カテゴリー（年度に紐づく）

## 📊 投票状況の表示

各提案には以下の情報が表示されます：

```
賛成: 3    反対: 1    必要: 3/5

[━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━] 100%

⏰ 残り約 24 時間
```

- **賛成数**: 現在の賛成票
- **反対数**: 現在の反対票
- **必要数**: 承認に必要な票数 / 総メンバー数
- **プログレスバー**: 承認までの進捗
- **残り時間**: 提案の有効期限まで

## 🔒 セキュリティと監査

### システム履歴への記録

以下のアクションが全てシステム履歴に記録されます：

1. **削除提案の作成**
   - 提案者
   - 年度名
   - 必要な承認数

2. **削除の実行**
   - 実行者
   - 投票結果（賛成数/反対数）
   - 削除されたデータの件数

### 履歴での確認

**履歴** > **システム履歴** タブで確認可能：
- 誰が提案したか
- 誰が投票したか（個別の投票内容はプライバシー保護のため非表示）
- 最終的な投票結果
- 誰が削除を実行したか

## 💡 実用例

### 例1: 5人のメンバー

- **メンバー数**: 5人
- **必要な承認数**: 3票（過半数）

**シナリオ A: 承認**
- 賛成: 3票、反対: 1票 → ✅ 承認

**シナリオ B: 否決**
- 賛成: 2票、反対: 3票 → ❌ 却下

**シナリオ C: 期限切れ**
- 賛成: 2票、反対: 1票、未投票: 2人 → ⏰ 期限切れ

### 例2: 3人のメンバー

- **メンバー数**: 3人
- **必要な承認数**: 2票

**シナリオ A: 承認**
- 賛成: 2票、反対: 0票 → ✅ 承認

**シナリオ B: 否決**
- 賛成: 1票、反対: 2票 → ❌ 却下

## ⚙️ 詳細設定

### 有効期限の変更

デフォルトは48時間ですが、変更可能です：

1. `create_deletion_voting_system.sql` を編集
2. 以下の行を変更:
```sql
expires_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW() + INTERVAL '48 hours'
```

例: 72時間に変更
```sql
expires_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW() + INTERVAL '72 hours'
```

### 過半数のルール変更

現在は「切り上げ過半数」（5人中3票、4人中3票）：

```typescript
const requiredApprovals = Math.ceil(totalMembers / 2) // 過半数
```

2/3に変更する場合:
```typescript
const requiredApprovals = Math.ceil(totalMembers * 2 / 3) // 2/3
```

## 🚨 トラブルシューティング

### Q: 提案が表示されない
**A:** ページを再読み込みしてください。データタブに切り替えると自動的に読み込まれます。

### Q: 投票ボタンが押せない
**A:** 既に投票済みの可能性があります。「あなたの投票: ✅ 賛成」または「❌ 反対」と表示されていませんか？

### Q: 期限切れの提案を再提案したい
**A:** もう一度「📋 削除を提案」ボタンを押してください。新しい提案が作成されます。

### Q: 誤って削除を実行してしまった
**A:** 削除されたデータは復元できません。事前にアーカイブを作成することを強く推奨します。

## 📖 関連ドキュメント

- `create_deletion_voting_system.sql` - データベーススキーマ
- `DATA_RETENTION_POLICY.md` - データ保持ポリシー
- システム履歴機能 - 監査証跡の確認

## ✅ まとめ

この多数決システムにより：
- ✅ 年度削除には複数人の承認が必要
- ✅ 全ての操作が記録される
- ✅ 民主的で透明性のある運営が可能
- ✅ 「みんなで見張る」設計思想を実現

年度削除という重要な操作を、組織全体で監視・承認できる仕組みです。
